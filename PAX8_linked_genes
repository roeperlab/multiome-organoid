# Code to generate PAX8 linked genes. Can be applied to any gene, as long as appropriate motif file is provided.
# PAX8 motif file used in this paper was downloaded from HOMER: http://homer.ucsd.edu/homer/motif/HomerMotifDB/homerResults/motif277.motif

# Use as input p2g.df.obs.sub generated by Multiome_pipeline (this file contains all peak-to-gene-links with FDR < 1e-4 and Cor > 0.4)

# In terminal:
/bin/bash

# Add Homer to PATH
export PATH=/Users/.../Homer/bin:$PATH 

# Peak-to-gene-links file p2g.df.obs.sub needs to be in correct format (MS-DOS .txt.). 
# FIRST - OPEN .csv file, delete first column and save as MS-DOS .txt
# THEN - Run this in terminal to change format:

changeNewLine.pl /...path_to.../p2g.df.obs.sub.txt


# Now search Peak-to-gene-links for instances of PAX8 motifs (make sure PAX8.motif file is in output_folder)
cd /....path_to..../output_folder
findMotifsGenome.pl /...path_to.../p2g.df.obs.sub.txt hg38 /....path_to..../output_folder -find PAX8.motif > PAX8.txt -size given -mask

# This generates a table of peaks containing overrepresentations of PAX8 motifs annonated by a corresponding PositionID

# Annotate linked peaks with gene names by importing this table into R. (the below code runs in R)

p2g.df.obs.sub <- read.delim(file = "~/Desktop/p2g.df.obs.sub.txt")
nrow(p2g.df.obs.sub) #91741 total

##Combine all Homer output peak files into 1 list (called myfiles) - useful if analysing more than one motif
setwd("/Volumes/Macintosh HD/Users/jblich/Desktop/homer_output/Cor04_FDR1e4_novar_2")
temp = list.files(pattern="*.txt")
links = lapply(temp, read.delim)

# Isolating PAX8 links
links <- merge(p2g.df.obs.sub, links, by.x="Unique_Peak_ID", by.y="PositionID") 
links <- links[,c("Unique_Peak_ID", "geneName","Correlation","Motif.Name", "peakType", "peakName")]
links.split <- str_split_fixed(links$Motif.Name, '\\(', n=Inf)
links$Motif.Name <- links[,1]
links[,4] = toupper(links[,4])
links <- links[!duplicated(links$Unique_Peak_ID),]
links <- arrange(links, links$geneName)

write.csv(links, file = "~/Desktop/Predicted_PAX8_regulon.csv") # tab a) in Supplemental Table 5




